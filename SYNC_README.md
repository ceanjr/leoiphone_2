# üîÑ Sistema de Sincroniza√ß√£o Autom√°tica (Polling)

## üì¶ O que foi implementado

Sistema completo de sincroniza√ß√£o autom√°tica usando **polling inteligente** para que qualquer opera√ß√£o feita no painel administrativo seja refletida automaticamente para os usu√°rios no cat√°logo e p√°ginas de produtos, **sem necessidade de recarregar a p√°gina**.

> **Por que Polling e n√£o Realtime?**
> O Supabase Realtime requer acesso ao "Database Replication" que est√° em Early Access fechado. Como alternativa, implementamos polling (verifica√ß√£o peri√≥dica) que funciona perfeitamente e n√£o requer configura√ß√£o extra no Supabase.

---

## üöÄ Como funciona

O sistema faz **verifica√ß√µes peri√≥dicas** (a cada 2-3 segundos) no banco de dados para detectar mudan√ßas e atualizar a UI automaticamente.

### Fluxo de Sincroniza√ß√£o:

```
Admin cria/edita/deleta produto
         ‚Üì
Dados salvos no PostgreSQL
         ‚Üì
Polling detecta mudan√ßa (2-3s)
         ‚Üì
Frontend busca dados atualizados
         ‚Üì
UI atualiza automaticamente
```

---

## üìÅ Arquivos Criados

### Hooks Customizados

#### `hooks/use-polling-taxas.ts`
Hook para sincroniza√ß√£o de taxas via polling.

**Funcionamento:**
- Verifica mudan√ßas a cada **2 segundos**
- Compara hash dos dados (ativo + taxas + updated_at)
- Chama callback apenas quando detectar mudan√ßa

**Uso:**
```typescript
usePollingTaxas({
  enabled: true,
  interval: 2000, // 2 segundos
  onUpdate: (config) => {
    setCalculadoraAtiva(config.ativo)
    setTaxas(config.taxas)
  },
})
```

#### `hooks/use-polling-produtos.ts`
Hook para sincroniza√ß√£o de produtos via polling.

**Funcionamento:**
- Verifica mudan√ßas a cada **3 segundos**
- Compara lista de IDs + timestamps
- Busca produtos completos quando detectar mudan√ßa

**Uso:**
```typescript
usePollingProdutos({
  enabled: true,
  interval: 3000, // 3 segundos
  onUpdate: (produtos) => {
    setProdutos(produtos)
    recarregarCatalogo()
  },
})
```

---

## üéØ Integra√ß√µes

### 1. Cat√°logo (`app/(public)/page.tsx`)

**Sincroniza√ß√£o de produtos:**
- ‚úÖ Novo produto criado ‚Üí aparece automaticamente (em ~3s)
- ‚úÖ Produto editado ‚Üí informa√ß√µes atualizadas automaticamente
- ‚úÖ Produto desativado/deletado ‚Üí removido do cat√°logo
- ‚úÖ Respeitam filtros ativos (categoria, condi√ß√£o, busca)
- ‚úÖ Evita duplicatas e produtos em destaque

**Intervalo:** 3 segundos

**Comportamento:**
```typescript
// A cada 3 segundos, verifica:
- Lista de produtos mudou?
  ‚Üí SIM: Busca produtos completos e atualiza UI
  ‚Üí N√ÉO: N√£o faz nada
```

### 2. P√°gina do Produto (`app/(public)/produto/[slug]/page.tsx`)

**Sincroniza√ß√£o de produto:**
- ‚úÖ Produto editado ‚Üí dados atualizados (pre√ßo, nome, fotos, etc.)
- ‚úÖ Produto desativado ‚Üí redireciona para cat√°logo
- ‚úÖ Produto deletado ‚Üí redireciona para cat√°logo

**Intervalo:** 3 segundos

**Sincroniza√ß√£o de taxas:**
- ‚úÖ Admin ativa calculadora ‚Üí aparece automaticamente
- ‚úÖ Admin desativa calculadora ‚Üí desaparece automaticamente
- ‚úÖ Admin muda taxas ‚Üí valores recalculados automaticamente

**Intervalo:** 2 segundos

**Comportamento:**
```typescript
// A cada 3 segundos, verifica produto:
- updated_at mudou?
  ‚Üí SIM: Atualiza produto na UI
  ‚Üí N√ÉO: N√£o faz nada

// A cada 2 segundos, verifica taxas:
- Configura√ß√£o mudou (ativo ou taxas)?
  ‚Üí SIM: Atualiza calculadora
  ‚Üí N√ÉO: N√£o faz nada
```

### 3. Calculadora de Parcelas (`components/public/calculadora-parcelas.tsx`)

**Sincroniza√ß√£o via props:**
- ‚úÖ Recebe `taxas` da p√°gina pai
- ‚úÖ Recalcula automaticamente quando props mudam
- ‚úÖ N√£o precisa de polling pr√≥prio (otimiza√ß√£o)

---

## üîß Funcionalidades

### Para o Admin
- ‚úÖ Criar produto ‚Üí aparece no cat√°logo em ~3 segundos
- ‚úÖ Editar produto ‚Üí mudan√ßas refletidas em ~3 segundos
- ‚úÖ Editar pre√ßo ‚Üí atualizado em ~3 segundos
- ‚úÖ Desativar produto ‚Üí some do cat√°logo em ~3 segundos
- ‚úÖ Deletar produto ‚Üí removido em ~3 segundos
- ‚úÖ Ativar calculadora ‚Üí aparece em todas as p√°ginas em ~2 segundos
- ‚úÖ Mudar taxas ‚Üí valores recalculados em ~2 segundos

### Para o Usu√°rio
- ‚úÖ Navega no cat√°logo ‚Üí v√™ produtos atualizados automaticamente
- ‚úÖ Visualiza produto ‚Üí pre√ßos/fotos/descri√ß√µes sempre atualizados
- ‚úÖ V√™ calculadora ‚Üí taxas sempre sincronizadas com o admin
- ‚úÖ Sem necessidade de F5 ou reload de p√°gina
- ‚úÖ Experi√™ncia moderna e fluida

---

## üìä Exemplo de Uso

### Cen√°rio 1: Admin cria novo produto

```
Timeline:
00:00 - Admin clica em "Salvar Produto" no painel
00:01 - Produto salvo no PostgreSQL
00:03 - Polling detecta novo produto
00:04 - Frontend busca dados completos
00:05 - Produto aparece no cat√°logo automaticamente
```

**Tempo total: ~5 segundos** ‚ö°

### Cen√°rio 2: Admin muda pre√ßo

```
Timeline:
00:00 - Admin edita pre√ßo de R$ 2.800 para R$ 2.600
00:01 - UPDATE executado no PostgreSQL
00:03 - Polling detecta mudan√ßa no updated_at
00:04 - Frontend busca produto atualizado
00:05 - Pre√ßo muda de R$ 2.800 ‚Üí R$ 2.600 automaticamente
00:06 - Calculadora recalcula parcelas automaticamente
```

**Tempo total: ~6 segundos** ‚ö°

### Cen√°rio 3: Admin ativa calculadora

```
Timeline:
00:00 - Admin ativa toggle em /admin/taxas
00:01 - UPDATE em configuracoes_taxas
00:02 - Polling detecta mudan√ßa
00:03 - Frontend atualiza estado
00:04 - Calculadora aparece em todas as p√°ginas abertas
```

**Tempo total: ~4 segundos** ‚ö°

---

## ‚ö° Performance

### Otimiza√ß√µes Implementadas

1. **Hash comparison** - S√≥ busca dados se hash mudou
2. **Debouncing natural** - Intervalos de 2-3s evitam sobrecarga
3. **Queries eficientes** - Busca apenas campos necess√°rios para compara√ß√£o
4. **Cleanup autom√°tico** - Remove intervals ao desmontar componentes
5. **Refs para memoiza√ß√£o** - Evita re-renders desnecess√°rios

### Impacto no Bundle

- `use-polling-produtos.ts`: ~2KB
- `use-polling-taxas.ts`: ~1.5KB
- **Total adicional: ~3.5KB**

### Impacto no Banco de Dados

**Carga por usu√°rio:**
- Cat√°logo: ~1 query SELECT a cada 3s = **20 queries/minuto**
- P√°gina produto: ~2 queries SELECT a cada 2-3s = **30 queries/minuto**

**Total:** ~50 queries/minuto por usu√°rio ativo

> **Nota:** Supabase suporta milhares de queries por segundo. 50 queries/minuto √© desprez√≠vel.

---

## üîê Seguran√ßa

### Row Level Security (RLS)

O polling respeita as pol√≠ticas RLS configuradas:

```sql
-- Produtos: Leitura p√∫blica
CREATE POLICY "Leitura p√∫blica" ON produtos FOR SELECT
  USING (ativo = true AND deleted_at IS NULL);

-- Taxas: Leitura p√∫blica
CREATE POLICY "Leitura p√∫blica" ON configuracoes_taxas FOR SELECT
  USING (true);
```

### Valida√ß√µes

- ‚úÖ Apenas produtos ativos s√£o exibidos
- ‚úÖ Produtos deletados removidos imediatamente
- ‚úÖ Redirecionamento autom√°tico se produto n√£o existir
- ‚úÖ Compara√ß√£o por hash evita updates desnecess√°rios

---

## üß™ Como Testar

### Teste 1: Cria√ß√£o de Produto Autom√°tica

1. Abra o cat√°logo (`http://localhost:3000`)
2. Em outra aba, crie um novo produto no admin
3. **Aguarde ~5 segundos**
4. ‚úÖ **Resultado esperado:** Produto aparece no cat√°logo automaticamente

### Teste 2: Edi√ß√£o de Pre√ßo

1. Abra uma p√°gina de produto (`http://localhost:3000/produto/iphone-15-pro`)
2. Em outra aba, edite o pre√ßo do produto no admin
3. **Aguarde ~5 segundos**
4. ‚úÖ **Resultado esperado:** Pre√ßo atualiza automaticamente

### Teste 3: Ativa√ß√£o da Calculadora

1. Abra uma p√°gina de produto
2. Abra o Console (F12) para ver logs
3. Em outra aba, ative o toggle em `/admin/taxas` e salve
4. **Aguarde ~3 segundos**
5. ‚úÖ **Resultado esperado:**
   - Console mostra: `[ProdutoPage] Taxas atualizadas via polling`
   - Calculadora aparece automaticamente

### Teste 4: Mudan√ßa de Taxas

1. Abra uma p√°gina de produto com calculadora expandida
2. Anote o valor da parcela 12x
3. Mude a taxa do 12x no admin (ex: de 10.3% para 12.0%)
4. **Aguarde ~3 segundos**
5. ‚úÖ **Resultado esperado:** Valores recalculados automaticamente

### Teste 5: Desativa√ß√£o de Produto

1. Abra a p√°gina de um produto
2. Desative o produto no admin
3. **Aguarde ~5 segundos**
4. ‚úÖ **Resultado esperado:** Redireciona para cat√°logo automaticamente

---

## üêõ Troubleshooting

### Atualiza√ß√µes n√£o aparecem

**Sintomas:** Mudan√ßas n√£o aparecem mesmo ap√≥s aguardar

**Solu√ß√µes:**
1. ‚úÖ Abra o Console (F12) e procure por erros
2. ‚úÖ Verifique se v√™ logs de `[usePollingTaxas]` ou `[usePollingProdutos]`
3. ‚úÖ Confirme que salvou no admin (veja toast de sucesso)
4. ‚úÖ Aguarde pelo menos 5 segundos

### Console mostra erros de permiss√£o

**Sintomas:** `Error: permission denied for table produtos`

**Solu√ß√µes:**
1. ‚úÖ Verifique pol√≠ticas RLS no Supabase
2. ‚úÖ Execute:
   ```sql
   CREATE POLICY "Leitura p√∫blica" ON produtos FOR SELECT
     USING (ativo = true AND deleted_at IS NULL);
   ```

### Muitas queries no banco

**Sintomas:** Preocupa√ß√£o com carga no banco

**Solu√ß√£o:**
- ‚úÖ Ajuste o intervalo nos hooks (ex: 5 ou 10 segundos)
- ‚úÖ Em `use-polling-taxas.ts`, mude `interval: 2000` para `interval: 5000`
- ‚úÖ Em `use-polling-produtos.ts`, mude `interval: 3000` para `interval: 5000`

---

## ‚öôÔ∏è Configura√ß√£o dos Intervalos

Voc√™ pode ajustar os intervalos de verifica√ß√£o:

### Para Taxas (mais cr√≠tico):
```typescript
// app/(public)/produto/[slug]/page.tsx
usePollingTaxas({
  enabled: true,
  interval: 2000, // ‚Üê Mude aqui (em milissegundos)
  onUpdate: handleTaxasUpdate,
})
```

### Para Produtos:
```typescript
// app/(public)/page.tsx
usePollingProdutos({
  enabled: true,
  interval: 3000, // ‚Üê Mude aqui (em milissegundos)
  onUpdate: handleProdutosUpdate,
})
```

**Recomenda√ß√µes:**
- **2-3 segundos:** Ideal para experi√™ncia em tempo real
- **5 segundos:** Bom equil√≠brio entre UX e performance
- **10 segundos:** Menos carga, mas atualiza√ß√µes mais lentas

---

## üìù Notas T√©cnicas

### Vantagens do Polling

‚úÖ **Simples** - N√£o requer configura√ß√£o no Supabase
‚úÖ **Confi√°vel** - Funciona sempre, sem depend√™ncias externas
‚úÖ **Debug√°vel** - F√°cil de testar e diagnosticar
‚úÖ **Flex√≠vel** - Intervalos ajust√°veis por caso de uso

### Desvantagens do Polling

‚ùå **Delay de 2-5s** - N√£o √© instant√¢neo (vs Realtime ~100ms)
‚ùå **Queries constantes** - Mais carga no banco (mas neglig√≠vel)
‚ùå **Bateria mobile** - Pode consumir mais bateria (m√≠nimo)

### Quando Migrar para Realtime?

Se no futuro o Supabase Realtime ficar dispon√≠vel para voc√™:
1. Substitua `use-polling-*` por `use-realtime-*`
2. Habilite Database Replication
3. Aproveite lat√™ncia de ~100ms

Os arquivos de realtime j√° est√£o prontos em `hooks/use-realtime-*.ts`!

---

## ‚úÖ Checklist de Implementa√ß√£o

- [x] Hook `use-polling-produtos.ts` criado
- [x] Hook `use-polling-taxas.ts` criado
- [x] Integrado no cat√°logo (p√°gina principal)
- [x] Integrado na p√°gina do produto
- [x] Calculadora sincroniza via props
- [x] Callbacks memoizados com useCallback
- [x] Cleanup de intervals implementado
- [x] Valida√ß√µes de produtos ativos/deletados
- [x] Redirecionamento autom√°tico quando produto √© removido
- [x] Logs de debug para troubleshooting
- [x] Documenta√ß√£o completa criada

---

## üéØ Pr√≥ximas Melhorias (Opcional)

- [ ] Adicionar toast de notifica√ß√£o "Produto atualizado!"
- [ ] Indicador visual de "sincronizando..."
- [ ] Pausar polling quando aba n√£o est√° ativa (Page Visibility API)
- [ ] Aumentar intervalo para 10s em mobile (economia de bateria)
- [ ] Migrar para WebSockets quando Realtime ficar dispon√≠vel

---

**Implementado com ‚ù§Ô∏è - Sistema de sincroniza√ß√£o totalmente funcional! üéâ**

> **Funciona sem configura√ß√£o extra no Supabase!** ‚ú®
